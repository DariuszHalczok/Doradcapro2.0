1. Struktura HTML (Kontener)

Ten fragment znajduje się w sekcji div.main-container. Wnętrze kontenera #bricksContainer jest generowane dynamicznie przez JavaScript.

<!-- STEP 3: CEGIEŁKI -->
<div id="step-3" class="step-content">
    <h1 class="page-title">Cegiełki (Opcje)</h1>
    
    <!-- Tutaj JavaScript wstrzykuje kafelki i ankiety -->
    <div id="bricksContainer"></div>
    
    <div class="form-actions">
        <button class="btn btn-secondary" onclick="prevStep()">Wstecz</button>
        <button class="btn btn-primary" onclick="nextStep()">Dalej <span class="material-icons-outlined">arrow_forward</span></button>
    </div>
</div>


2. Logika JavaScript

Poniższe funkcje odpowiadają za renderowanie opcji w zależności od grupy wiekowej klienta oraz obsługę interakcji. Zaktualizowano logikę Kardio (3 pytania).

// Zmienna globalna przechowująca wybrane dodatki
let activeAddonsMap = new Map();

// Tablica przechowująca stan odpowiedzi na pytania kardiologiczne [null, null, null]
// null = brak odpowiedzi, true = TAK (chory), false = NIE (zdrowy)
let kardioAnswers = [null, null, null]; 

/**
 * Główna funkcja renderująca Krok 3.
 * Uruchamiana automatycznie po przejściu z Kroku 1 (Wiek).
 * @param {number} group - Grupa wiekowa klienta (1: 18-54, 2: 55-69, 3: 70+)
 */
function renderBricks(group) {
    const c = document.getElementById('bricksContainer'); 
    c.innerHTML = ''; // Czyścimy kontener
    activeAddonsMap.clear(); // Resetujemy wybrane opcje
    kardioAnswers = [null, null, null]; // Resetujemy ankietę kardio

    // Logika dla seniorów (Grupa 3) - brak cegiełek
    if(group === 3) { 
        c.innerHTML='<p style="text-align:center">Brak cegiełek dla Seniora</p>'; 
        updateStickyTotal(); 
        return; 
    }
    
    const brickPrice = 29.90;

    // Definicja standardowych cegiełek (Active, Kids)
    const stdBricks = [
        {
            id:'active', 
            n:'Pakiet Active (40 000 zł)', 
            p:brickPrice, 
            d:'<ul><li>Trwały uszczerbek: 40 000 zł</li><li>Szpital NW: 400 zł/dzień</li><li>Rekonwalescencja</li></ul>'
        },
        {
            id:'kids', 
            n:'Pakiet Kids', 
            p:brickPrice, 
            d:'<ul><li>Śmierć dziecka NW: 20 000 zł</li><li>Poważne zachorowanie: 10 000 zł</li><li>Szpital dziecka</li></ul>'
        }
    ];
    
    // Generowanie HTML dla standardowych cegiełek
    const div = document.createElement('div'); 
    div.className='options-grid';
    stdBricks.forEach(b => {
        const lbl = document.createElement('label'); 
        lbl.className='option-card';
        lbl.innerHTML = `<input type="checkbox" onchange="toggleAddon('${b.id}',${b.p},'${b.n}')"><div><strong>${b.n} (+${b.p.toFixed(2)} zł)</strong>${b.d}</div>`;
        div.appendChild(lbl);
    });
    c.appendChild(div);

    // --- SEKCJA MEDYCZNA ---
    const medDiv = document.createElement('div'); 
    medDiv.className='form-section'; 
    medDiv.style.marginTop='20px';
    
    const specPrice = group===1 ? 29.90 : 49.90;
    
    // Opisy świadczeń
    const onkoDesc = group===1 
        ? '<ul><li>Nowotwór: 40 000 zł</li><li>Szpital: 250 zł/dzień</li><li>Leczenie: 5 000 zł</li></ul>' 
        : '<ul><li>Nowotwór: 20 000 zł</li><li>Szpital: 200 zł/dzień</li><li>Leczenie: 7 000 zł</li></ul>';
    const kardioDesc = group===1 
        ? '<ul><li>Zawał/Udar: 50 000 zł</li><li>Szpital: 200 zł/dzień</li><li>Leczenie: 5 000 zł</li></ul>' 
        : '<ul><li>Zawał/Udar: 20 000 zł</li><li>Szpital: 100 zł/dzień</li><li>Leczenie: 5 000 zł</li></ul>';

    // Pytanie Onko (pojedyncze)
    const onkoQ = `Czy był /a Pan /i kiedykolwiek leczony/a z powodu nowotworu złośliwego (raka, mięsaka, czerniaka złośliwego, chłoniaka, białaczki lub innej formy nowotworu złośliwego) lub czy jest Pan/i diagnozowany/a w związku z objawami sugerującymi chorobę nowotworową?`;

    // Pytania Kardio (Podzielone na 3)
    const kardioQuestionsList = [
        "1. Czy kiedykolwiek rozpoznawano lub był/a Pan/i leczony/a z powodu zawału serca, choroby niedokrwiennej serca (choroby wieńcowej), miażdżycy tętnic kończyn dolnych i/lub tętnic szyjnych, cukrzycy, udaru mózgu, przemijających zaburzeń krążenia mózgowego?",
        "2. Czy w ciągu ostatnich 5 lat był/a Pan/i leczony/a w szpitalu z powodu niewydolności serca, zaburzeń rytmu serca, wady zastawkowej serca, zaburzeń neurologicznych?",
        "3. Czy w ciągu ostatnich 3 miesięcy zalecono Panu/i przeprowadzenie diagnostyki w związku z podejrzeniem istnienia schorzeń wymienionych powyżej?"
    ];

    // Budowanie HTML pytań Kardio (pętla)
    let kardioQuestionsHTML = '';
    kardioQuestionsList.forEach((q, index) => {
        kardioQuestionsHTML += `
            <div class="medical-sub-question" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee;">
                <div class="medical-question" style="font-size: 0.9em; margin-bottom: 8px;">${q}</div>
                <div class="medical-actions">
                    <button class="health-btn" onclick="handleHealth(true, this, 'kardio', ${index})">TAK</button>
                    <button class="health-btn" onclick="handleHealth(false, this, 'kardio', ${index})">NIE</button>
                </div>
            </div>
        `;
    });

    // Wstrzykiwanie HTML całej sekcji medycznej
    medDiv.innerHTML = `
        <h3>Pakiety Specjalistyczne</h3>
        
        <!-- Ankieta Onkologiczna -->
        <div class="medical-section">
            <strong style="color:var(--ovb-blue); display:block; margin-bottom:10px;">Ankieta Onkologiczna</strong>
            <div class="medical-question">${onkoQ}</div>
            <div class="medical-actions">
                <button class="health-btn" onclick="handleHealth(true, this, 'onko')">TAK</button>
                <button class="health-btn" onclick="handleHealth(false, this, 'onko')">NIE</button>
            </div>
            <div id="onkoReveal" class="addon-reveal">
                <span class="addon-reveal-label">Jesteś uprawniony:</span>
                <label class="option-card">
                    <input type="checkbox" id="chk_onko" onchange="toggleAddon('onko', ${specPrice}, 'Onko')">
                    <div class="option-content"><strong>Onko (+${specPrice.toFixed(2)} zł)</strong><small>${onkoDesc}</small></div>
                </label>
            </div>
        </div>

        <!-- Ankieta Kardiologiczna (Zaktualizowana) -->
        <div class="medical-section">
            <strong style="color:var(--ovb-blue); display:block; margin-bottom:10px;">Ankieta Kardiologiczna</strong>
            ${kardioQuestionsHTML} <!-- Wstawienie 3 pytań -->
            
            <div id="kardioReveal" class="addon-reveal">
                <span class="addon-reveal-label">Jesteś uprawniony (Wszystkie odpowiedzi NIE):</span>
                <label class="option-card">
                    <input type="checkbox" id="chk_kardio" onchange="toggleAddon('kardio', ${specPrice}, 'Kardio')">
                    <div class="option-content"><strong>Kardio (+${specPrice.toFixed(2)} zł)</strong><small>${kardioDesc}</small></div>
                </label>
            </div>
        </div>
    `;
    c.appendChild(medDiv);
    updateStickyTotal();
}

/**
 * Obsługuje zaznaczenie/odznaczenie checkboxa cegiełki.
 */
function toggleAddon(id, p, n) {
    if(activeAddonsMap.has(id)) {
        activeAddonsMap.delete(id); 
    } else {
        activeAddonsMap.set(id, {price:p, name:n});
    }
    updateStickyTotal(); 
}

/**
 * Obsługuje ankiety medyczne.
 * Dla 'kardio' obsługuje logikę 3 pytań (wszystkie muszą być na NIE).
 * @param {boolean} isYes - Odpowiedź klienta
 * @param {HTMLElement} btn - Kliknięty przycisk
 * @param {string} type - 'onko' lub 'kardio'
 * @param {number} index - Indeks pytania (tylko dla kardio)
 */
function handleHealth(isYes, btn, type, index = -1) {
    // 1. Styling przycisków
    const siblings = btn.parentElement.querySelectorAll('.health-btn');
    siblings.forEach(b => b.className = 'health-btn'); 
    if(isYes) btn.classList.add('selected-yes'); else btn.classList.add('selected-no');

    const reveal = document.getElementById(type + 'Reveal');
    const chk = document.getElementById('chk_' + type);

    // 2. Logika dla ONKO (prosta, 1 pytanie)
    if (type === 'onko') {
        if(isYes) {
            reveal.classList.remove('visible'); 
            if(chk && chk.checked) { chk.checked = false; toggleAddon(type, 0, ''); }
        } else {
            reveal.classList.add('visible');
        }
    } 
    // 3. Logika dla KARDIO (złożona, 3 pytania)
    else if (type === 'kardio') {
        // Zapisz odpowiedź w tablicy stanu
        if (index >= 0) kardioAnswers[index] = isYes;

        // Sprawdź czy wszystkie 3 pytania mają odpowiedź
        const allAnswered = kardioAnswers.every(ans => ans !== null);
        // Sprawdź czy jakakolwiek odpowiedź to TAK
        const anyYes = kardioAnswers.some(ans => ans === true);

        if (allAnswered && !anyYes) {
            // Wszystkie zaznaczone i wszystkie na NIE -> Pokaż ofertę
            reveal.classList.add('visible');
        } else {
            // Brakuje odpowiedzi LUB jest jakieś TAK -> Ukryj ofertę
            reveal.classList.remove('visible');
            if(chk && chk.checked) { 
                chk.checked = false; 
                toggleAddon(type, 0, ''); 
            }
        }
    }
}


3. Kluczowe Style CSS

Dodano style dla pod-pytań, aby oddzielić je wizualnie.

/* Grid dla standardowych cegiełek */
.options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }

/* Wygląd kafelka */
.option-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; display: flex; gap: 10px; cursor: pointer; transition: 0.2s; align-items: flex-start; }
.option-card:hover { border-color: var(--ovb-blue); background: #fafafa; }
.option-card input { margin-top: 4px; accent-color: var(--ovb-teal); flex-shrink: 0; width: 20px; height: 20px; }

/* Sekcja medyczna */
.medical-section { background: #fff; border: 1px solid var(--ovb-light-grey); border-radius: 8px; padding: 20px; margin-top: 20px; }
.medical-question { font-size: 0.95em; color: var(--ovb-text); line-height: 1.5; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-left: 4px solid var(--ovb-blue); border-radius: 4px; }
/* Nowy styl dla separatora pytań w kardio */
.medical-sub-question:last-child { border-bottom: none !important; margin-bottom: 0 !important; }

/* Przyciski TAK/NIE */
.health-btn { padding: 8px 25px; border: 1px solid #ccc; background: white; border-radius: 20px; cursor: pointer; transition: 0.2s; font-weight: 600; color: #666; margin-right: 10px; }
.health-btn:hover { background: #f0f0f0; }
.health-btn.selected-yes { background: var(--ovb-hot-pink); color: white; border-color: var(--ovb-hot-pink); }
.health-btn.selected-no { background: var(--ovb-teal); color: white; border-color: var(--ovb-teal); }

/* Ukryty panel dodatku */
.addon-reveal { display: none; animation: fadeIn 0.5s; padding: 15px; background: #F0FCFC; border-radius: 8px; border: 1px solid var(--ovb-teal); margin-top: 10px; }
.addon-reveal.visible { display: block; }
